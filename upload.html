<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏û‡∏£‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h2>üì§ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏û‡∏£‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</h2>
  <button onclick="logout()">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
  <form id="uploadForm">
    <input type="text" name="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏£‡∏∞" required><br>
    <input type="text" name="price" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤" required><br>
    <textarea name="description" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î"></textarea><br>
    <input type="file" name="image1"><br>
    <input type="file" name="image2"><br>
    <input type="file" name="image3"><br>
    <input type="file" name="image4"><br>
    <button type="submit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
  </form>
  <div id="status"></div>

  <script>
    const SUPABASE_URL = "https://srzqmhgdaedfoyakqmpg.supabase.co"
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY)

    async function checkLoginAndRole() {
      const { data: { user } } = await supabase.auth.getUser()
      if (!user) {
        window.location.href = 'login.html'
        return
      }
      const role = user.user_metadata?.role
      if (role !== 'admin') {
        alert('‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ')
        window.location.href = 'dashboard.html'
      }
    }
    checkLoginAndRole()

    async function logout() {
      await supabase.auth.signOut()
      window.location.href = 'login.html'
    }

    document.getElementById('uploadForm').addEventListener('submit', async (e) => {
      e.preventDefault()
      const form = e.target
      const name = form.name.value
      const price = parseFloat(form.price.value)
      const description = form.description.value
      const status = document.getElementById('status')
      status.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...'

      const image_code = Math.random().toString(36).substring(2, 8).toUpperCase()
      const imageUrls = {}

      for (let i = 1; i <= 4; i++) {
        const file = form[`image${i}`].files[0]
        if (file) {
          const path = `${image_code}_${i}.jpg`
          const { error } = await supabase.storage.from('amulet-images').upload(path, file)
          if (error) {
            status.textContent = `‚ùå ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà ${i} ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ` + error.message
            return
          }
          imageUrls[`image_url${i}`] = `${SUPABASE_URL}/storage/v1/object/public/amulet-images/${path}`
        }
      }

      const { error: insertError } = await supabase.from('amulets').insert([{
        name,
        price,
        description,
        ...imageUrls
      }])

      if (insertError) {
        status.textContent = '‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + insertError.message
        return
      }

      status.innerHTML = `‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏£‡∏´‡∏±‡∏™‡∏†‡∏≤‡∏û: ${image_code}`
      form.reset()
    })
  </script>
</body>
</html>
