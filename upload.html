import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const SUPABASE_URL = "https://labxpswxsaqzlubzqaoy.supabase.co"
const SUPABASE_KEY = "sb_publishable_Y9rCpK1TISgMhRauvQLBSg_xpK4Mka2"

const supabase = createClient(SUPABASE_URL, SUPABASE_KEY)

const form = document.getElementById('uploadForm')
const status = document.getElementById('status')

form.addEventListener('submit', async (e) => {
  e.preventDefault()
  status.textContent = '⏳ กำลังอัปโหลด...'

  const name = form.name.value
  const price = parseFloat(form.price.value)
  const file = form.image.files[0]
  const image_code = generateRandomCode()

  if (!file || !name || isNaN(price)) {
    status.textContent = '❌ กรุณากรอกข้อมูลให้ครบ'
    return
  }

  try {
    const { error: uploadError } = await supabase.storage
      .from('amulet-images')
      .upload(`${image_code}.jpg`, file)

    if (uploadError) {
      status.textContent = '❌ อัปโหลดภาพไม่สำเร็จ: ' + uploadError.message
      return
    }

    const { error: insertError } = await supabase
      .from('amulets') // ตรวจสอบว่า table นี้มีอยู่ใน Supabase
      .insert([{ name, price, image_code }])

    if (insertError) {
      status.textContent = '❌ บันทึกข้อมูลไม่สำเร็จ: ' + insertError.message
      return
    }

    const imageUrl = `${SUPABASE_URL}/storage/v1/object/public/amulet-images/${image_code}.jpg`
    status.innerHTML = `✅ อัปโหลดสำเร็จ!<br>รหัสภาพ: ${image_code}<br><img src="${imageUrl}" style="max-width:300px;">`
    form.reset()
  } catch (err) {
    status.textContent = '❌ เกิดข้อผิดพลาด: ' + err.message
  }
})

function generateRandomCode() {
  return Math.random().toString(36).substring(2, 8).toUpperCase()
}
