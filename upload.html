
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏û‡∏£‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #fffbe6; }
    h2 { color: #b48b00; }
    input, textarea, button { margin: 5px 0; width: 100%; padding: 8px; }
    button { background: #b48b00; color: white; border: none; cursor: pointer; }
    button:hover { background: #d4a017; }
    #status { margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>
  <h2>üì§ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏û‡∏£‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</h2>
  <button onclick="logout()">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>

  <form id="uploadForm">
    <input type="text" name="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏£‡∏∞" required><br>
    <input type="text" name="price" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤" required><br>
    <textarea name="description" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î"></textarea><br>
    <input type="file" name="image1" accept="image/*"><br>
    <input type="file" name="image2" accept="image/*"><br>
    <input type="file" name="image3" accept="image/*"><br>
    <input type="file" name="image4" accept="image/*"><br>
    <button type="submit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
  </form>

  <div id="status"></div>

  <script>
    const SUPABASE_URL = "https://srzqmhgdaedfoyakqmpg.supabase.co"
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." // üîí ‡πÉ‡∏ä‡πâ Key ‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY)

    async function checkLoginAndRole() {
      const { data: { user }, error } = await supabase.auth.getUser()
      if (!user) {
        window.location.href = 'login.html'
        return
      }
      const role = user.user_metadata?.role
      if (role !== 'admin') {
        alert('‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ')
        window.location.href = 'dashboard.html'
      }
    }
    checkLoginAndRole()

    async function logout() {
      await supabase.auth.signOut()
      window.location.href = 'login.html'
    }

    document.getElementById('uploadForm').addEventListener('submit', async (e) => {
      e.preventDefault()
      const form = e.target
      const name = form.name.value.trim()
      const price = form.price.value.trim()
      const description = form.description.value.trim()
      const status = document.getElementById('status')
      status.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...'

      const { data: { user }, error: userError } = await supabase.auth.getUser()
      if (userError || !user) {
        status.textContent = '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô'
        return
      }

      const image_code = Math.random().toString(36).substring(2, 8).toUpperCase()
      const imageUrls = {}

      for (let i = 1; i <= 4; i++) {
        const file = form[`image${i}`].files[0]
        if (file) {
          const path = `${image_code}_${i}.jpg`
          const { error: uploadError } = await supabase.storage.from('amulet-images').upload(path, file)
          if (uploadError) {
            status.textContent = `‚ùå ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà ${i} ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ` + uploadError.message
            return
          }
          imageUrls[`image_url${i}`] = `${SUPABASE_URL}/storage/v1/object/public/amulet-images/${path}`
        }
      }

      const { error: insertError } = await supabase.from('amulets').insert([{
        name,
        price,
        description,
        user_image_code: image_code,
        created_at: new Date().toISOString(),
        user_id: user.id,
        image_url1: imageUrls.image_url1 || null,
        image_url2: imageUrls.image_url2 || null,
        image_url3: imageUrls.image_url3 || null,
        image_url4: imageUrls.image_url4 || null
      }])

      if (insertError) {
        status.textContent = '‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + insertError.message
        return
      }

      status.innerHTML = `‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏£‡∏´‡∏±‡∏™‡∏†‡∏≤‡∏û: ${image_code}`
      form.reset()
    })
  </script>
</body>
</html>
