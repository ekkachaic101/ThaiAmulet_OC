
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏£‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</title>
  <style>
    body { font-family: sans-serif; background-color: #fffaf0; }
    .container { max-width: 1000px; margin: auto; padding: 20px; }
    form, .search-box { background-color: #fff8dc; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input, textarea, select { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; }
    button { margin-top: 15px; padding: 10px 20px; background-color: #f0c040; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
    button:hover { background-color: #e0b030; }
    .preview { margin-top: 10px; max-width: 150px; border-radius: 6px; border: 1px solid #aaa; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    table { width: 100%; border-collapse: collapse; margin-top: 30px; background-color: #fff8dc; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
    th { background-color: #f0e68c; }
    img.table-img { width: 80px; height: auto; border-radius: 6px; border: 1px solid #aaa; box-shadow: 0 2px 4px rgba(0,0,0,0.2); object-fit: cover; }
  </style>
</head>
<body>
  <nav class="navbar">
    <ul>
      <li><a href="index.html">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a></li>
      <li><a href="add.html">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏£‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</a></li>
      <li><a href="list.html">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a></li>
      <li><a href="stats.html">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</a></li>
    </ul>
  </nav>

  <div class="container">
    <h2>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏£‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</h2>
    <form id="add-form">
      <label>‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏£‡∏∞:</label>
      <input type="text" id="name" required>
      <label>‡∏£‡∏≤‡∏Ñ‡∏≤:</label>
      <input type="number" id="price" required>
      <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</label>
      <textarea id="description" rows="4"></textarea>
      <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏û‡∏£‡∏∞:</label>
      <input type="text" id="category">
      <label>‡∏†‡∏≤‡∏û‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤:</label>
      <input type="file" id="image1" accept="image/*">
      <img id="preview1" class="preview">
      <label>‡∏†‡∏≤‡∏û‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á:</label>
      <input type="file" id="image2" accept="image/*">
      <img id="preview2" class="preview">
      <label>‡∏†‡∏≤‡∏û‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏á:</label>
      <input type="file" id="image3" accept="image/*">
      <img id="preview3" class="preview">
      <label>‡∏†‡∏≤‡∏û‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á:</label>
      <input type="file" id="image4" accept="image/*">
      <img id="preview4" class="preview">
      <button type="submit" id="submit-button">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </form>

    <div class="search-box">
      <h3>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏û‡∏£‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</h3>
      <label>‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏£‡∏∞:</label>
      <input type="text" id="search-name">
      <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</label>
      <input type="text" id="search-description">
      <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏û‡∏£‡∏∞:</label>
      <input type="text" id="search-category">
      <label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î:</label>
      <input type="number" id="search-price-min">
      <label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î:</label>
      <input type="number" id="search-price-max">
      <button onclick="applyFilters()">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
      <button onclick="resetFilters()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
    </div>

    <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏£‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</h3>
    <table>
      <thead>
        <tr>
          <th>‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏£‡∏∞</th>
          <th>‡∏£‡∏≤‡∏Ñ‡∏≤</th>
          <th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
          <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
          <th>‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤</th>
          <th>‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á</th>
          <th>‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏á</th>
          <th>‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</th>
          <th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        </tr>
      </thead>
      <tbody id="amulet-table-body">
        <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏î‡∏¢ JavaScript -->
      </tbody>
    </table>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
    const supabase = createClient(
      'https://srzqmhgdaedfoyakqmpg.supabase.co',
      'YOUR_SUPABASE_PUBLIC_ANON_KEY'
    );

    let sessionToken = null;
    let userId = null;

    async function uploadImage(file) {
      if (!file || !sessionToken) return null;
      const filePath = `public/${Date.now()}_${file.name}`;
      const { data, error } = await supabase.storage
        .from("amulet-images")
        .upload(filePath, file, {
          upsert: false,
          headers: { Authorization: `Bearer ${sessionToken}` }
        });
      if (error) {
        console.error("Upload error:", error);
        alert("‚ùå ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);
        return null;
      }
      return `https://srzqmhgdaedfoyakqmpg.supabase.co/storage/v1/object/public/amulet-images/${filePath}`;
    }

    async function loadTable(filters = {}) {
      let query = supabase.from("amulets").select("*").order("created_at", { ascending: false });

      if (filters.name) query = query.ilike("name", `%${filters.name}%`);
      if (filters.description) query = query.ilike("description", `%${filters.description}%`);
      if (filters.category) query = query.ilike("category", `%${filters.category}%`);
      if (filters.priceMin) query = query.gte("price", filters.priceMin);
      if (filters.priceMax) query = query.lte("price", filters.priceMax);

      const { data, error } = await query;
      if (error) {
        console.error("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:", error);
        return;
      }

      const tableBody = document.getElementById("amulet-table-body");
      tableBody.innerHTML = "";
      data.forEach(item => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${item.name}</td>
          <td>${item.price}</td>
          <td>${item.description || "-"}</td>
          <td>${item.category || "-"}</td>
          <td>${item.image_url1 ? `<img src="${item.image_url1}" class="table-img">` : ""}</td>
          <td>${item.image_url2 ? `<img src="${item.image_url2}" class="table-img">` : ""}</td>
          <td>${item.image_url3 ? `<img src="${item.image_url3}" class="table-img">` : ""}</td>
          <td>${item.image_url4 ? `<img src="${item.image_url4}" class="table-img">` : ""}</td>
          <td>
            <button onclick="editAmulet('${item.id}')">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            <button onclick="deleteAmulet('${item.id}')">üóëÔ∏è ‡∏•‡∏ö</button>
          </td>
        `;
        tableBody.appendChild(row);
      });
    }

    async function deleteAmulet(id) {
      if (!confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏û‡∏£‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
      const { error } = await supabase.from("amulets").delete().eq("id", id);
      if (error) {
        alert("‚ùå ‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);
      } else {
        alert("‚úÖ ‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß");
        await loadTable();
      }
    }

    async function editAmulet(id) {
      const { data, error } = await supabase.from("amulets").select("*").eq("id", id).single();
      if (error || !data) {
        alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: " + error.message);
        return;
      }
      document.getElementById("name").value = data.name;
      document.getElementById("price").value = data.price;
      document.getElementById("description").value = data.description;
      document.getElementById("category").value = data.category;
      document.getElementById("add-form").dataset.editId = id;
      document.getElementById("submit-button").textContent = "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
    }

    function applyFilters() {
      const filters = {
        name: document.getElementById("search-name").value.trim(),
        description: document.getElementById("search-description").value.trim(),
        category: document.getElementById("search-category").value.trim(),
        priceMin: document.getElementById("search-price-min").value,
        priceMax: document.getElementById("search-price-max").value
      };
      loadTable(filters);
    }

    function resetFilters() {
      document.getElementById("search-name").value = "";
      document.getElementById("search-description").value = "";
      document.getElementById("search-category").value = "";
      document.getElementById("search-price-min").value = "";
      document.getElementById("search-price-max").value = "";
      loadTable();
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const { data: sessionData } = await supabase.auth.getSession();
      sessionToken = sessionData.session.access_token;
      userId = sessionData.session.user.id;

      await loadTable();

      const form = document.getElementById("add-form");
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const name = document.getElementById("name").value.trim();
        const price = parseFloat(document.getElementById("price").value);
        const description = document.getElementById("description").value.trim();
        const category = document.getElementById("category").value.trim();
        const imageFile1 = document.getElementById("image1").files[0];
        const imageFile2 = document.getElementById("image2").files[0];
        const imageFile3 = document.getElementById("image3").files[0];
        const imageFile4 = document.getElementById("image4").files[0];
        const editId = form.dataset.editId;

        const imageUrl1 = await uploadImage(imageFile1);
        const imageUrl2 = await uploadImage(imageFile2);
        const imageUrl3 = await uploadImage(imageFile3);
        const imageUrl4 = await uploadImage(imageFile4);

        if (editId) {
          const { error } = await supabase.from("amulets").update({
            name, price, description, category,
            image_url1: imageUrl1,
            image_url2: imageUrl2,
            image_url3: imageUrl3,
            image_url4: imageUrl4
          }).eq("id", editId);
          if (error) {
            alert("‚ùå ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);
            return;
          }
          alert("‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!");
          form.reset();
          delete form.dataset.editId;
          document.getElementById("submit-button").textContent = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
          await loadTable();
          return;
        }

        const { error } = await supabase.from("amulets").insert([{
          name, price, description, category,
          image_url1: imageUrl1,
          image_url2: imageUrl2,
          image_url3: imageUrl3,
          image_url4: imageUrl4,
          created_at: new Date().toISOString(),
          user_id: userId
        }]);
        if (error) {
          alert("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);
          return;
        }
        alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!");
        form.reset();
        await loadTable();
      });
    });
  </script>
</body>
</html>
